<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda de Licencias - NetSolutions</title>
    <link rel="stylesheet" href="style.css">
    <!-- SDK de Amazon Cognito -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1093.0.min.js"></script>
</head>
<body>

    <div class="container">
        <header>
            <h1>NetSolutions</h1>
            <div id="auth-section" class="auth-section">
                <div id="logged-out-view">
                    <button onclick="showAuthModal('login')">Iniciar Sesión</button>
                    <button onclick="showAuthModal('register')" class="primary">Registrarse</button>
                </div>
                <div id="logged-in-view" class="hidden">
                    <span id="user-email"></span>
                    <button onclick="logout()">Cerrar Sesión</button>
                </div>
            </div>
        </header>

        <main>
            <div id="admin-controls" class="admin-controls hidden">
                <h2>Panel de Administrador</h2>
                <button onclick="showProductModal()" class="primary">+ Añadir Nuevo Producto</button>
            </div>

            <h2>Venta de Licencias de Software</h2>
            <div id="product-grid" class="product-grid">
                <p class="loader">Cargando productos...</p>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 NetSolutions S.A.S. - Arquitectura en AWS</p>
        </footer>
    </div>

    <!-- Modal de Autenticación -->
    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="auth-modal-title">Iniciar Sesión</h2>
            <form id="auth-form">
                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" required>
                </div>
                <div id="confirm-password-group" class="form-group hidden">
                    <label for="confirm-password">Confirmar Contraseña</label>
                    <input type="password" id="confirm-password">
                </div>
                <p id="auth-error" class="error-message hidden"></p>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAuthModal()">Cancelar</button>
                    <button type="submit" class="primary" id="auth-submit-button">Acceder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Producto (Crear/Editar) -->
    <div id="product-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 id="product-modal-title">Añadir Nuevo Producto</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="form-group">
                    <label for="product-name">Nombre</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label for="product-description">Descripción</label>
                    <textarea id="product-description" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="product-category">Categoría</label>
                    <input type="text" id="product-category" required>
                </div>
                <div class="form-group">
                    <label for="product-price">Precio (USD)</label>
                    <input type="number" id="product-price" step="0.01" required>
                </div>
                <p id="product-error" class="error-message hidden"></p>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeProductModal()">Cancelar</button>
                    <button type="submit" class="primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Configuración (inyectada por Terraform) ---
        const COGNITO_USER_POOL_ID = '${cognito_user_pool_id}';
        const COGNITO_CLIENT_ID = '${cognito_app_client_id}';
        const API_URL = '${api_url}';
        const AWS_REGION = 'us-east-1'; // La región donde está el User Pool

        // --- Estado de la Aplicación ---
        let state = {
            isLoggedIn: false,
            jwtToken: null,
            products: []
        };

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            AWS.config.update({ region: AWS_REGION });
            
            const token = localStorage.getItem('jwtToken');
            if (token) {
                state.jwtToken = token;
                state.isLoggedIn = true;
                // Aquí podrías decodificar el token para obtener el email, pero lo simplificaremos
                const email = localStorage.getItem('userEmail');
                if(email) document.getElementById('user-email').textContent = email;
            }

            updateUI();
            fetchProducts();

            document.getElementById('auth-form').addEventListener('submit', handleAuthFormSubmit);
            document.getElementById('product-form').addEventListener('submit', handleProductFormSubmit);
        });

        // --- Lógica de UI ---
        function updateUI() {
            document.getElementById('logged-in-view').classList.toggle('hidden', !state.isLoggedIn);
            document.getElementById('logged-out-view').classList.toggle('hidden', state.isLoggedIn);
            document.getElementById('admin-controls').classList.toggle('hidden', !state.isLoggedIn);
            renderProducts(); // Re-renderizar productos para mostrar/ocultar botones de admin
        }

        function showAuthModal(mode) { // 'login' or 'register'
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('auth-modal-title').textContent = mode === 'login' ? 'Iniciar Sesión' : 'Registrarse';
            document.getElementById('auth-submit-button').textContent = mode === 'login' ? 'Acceder' : 'Crear Cuenta';
            document.getElementById('confirm-password-group').classList.toggle('hidden', mode === 'login');
            document.getElementById('auth-form').dataset.mode = mode;
            document.getElementById('auth-error').classList.add('hidden');
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }

        function showProductModal(product = null) {
            document.getElementById('product-modal').classList.remove('hidden');
            const form = document.getElementById('product-form');
            if (product) {
                document.getElementById('product-modal-title').textContent = 'Editar Producto';
                form.dataset.mode = 'edit';
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-description').value = product.description;
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-price').value = product.price;
            } else {
                document.getElementById('product-modal-title').textContent = 'Añadir Nuevo Producto';
                form.dataset.mode = 'create';
                form.reset();
            }
            document.getElementById('product-error').classList.add('hidden');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        // --- Lógica de Datos (API) ---
        async function fetchProducts() {
            const productGrid = document.getElementById('product-grid');
            productGrid.innerHTML = '<p class="loader">Cargando productos...</p>';
            try {
                const response = await fetch(`${API_URL}/products`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                state.products = await response.json();
                renderProducts();
            } catch (error) {
                console.error('Error al cargar productos:', error);
                productGrid.innerHTML = '<p>Error al cargar los productos.</p>';
            }
        }

        function renderProducts() {
            const productGrid = document.getElementById('product-grid');
            if (state.products.length === 0) {
                productGrid.innerHTML = '<p>No hay productos disponibles.</p>';
                return;
            }
            productGrid.innerHTML = state.products.map(product => `
                <div class="product-card">
                    <div class="product-card-content">
                        <h3>${product.name}</h3>
                        <p>${product.description}</p>
                        <p class="product-price">$${product.price} USD</p>
                        ${state.isLoggedIn ? `
                        <div class="product-card-actions">
                            <button class="btn-secondary" onclick="showProductModal(state.products.find(p => p.id === '${product.id}'))">Editar</button>
                            <button class="btn-danger" onclick="deleteProduct('${product.id}')">Borrar</button>
                        </div>
                        ` : '
                        <button class="buy-button" onclick="purchaseProduct('${product.id}')">Comprar Ahora</button>'
                        }
                    </div>
                </div>
            `).join('');
        }

        async function handleProductFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const mode = form.dataset.mode;
            const productData = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                category: document.getElementById('product-category').value,
                price: parseFloat(document.getElementById('product-price').value),
            };
            const productId = document.getElementById('product-id').value;
            const url = mode === 'edit' ? `${API_URL}/products/${productId}` : `${API_URL}/products`;
            const method = mode === 'edit' ? 'PUT' : 'POST';

            try {
                const response = await apiRequest(url, method, productData);
                closeProductModal();
                fetchProducts(); // Recargar la lista
            } catch (error) {
                document.getElementById('product-error').textContent = error.message;
                document.getElementById('product-error').classList.remove('hidden');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este producto?')) return;
            try {
                await apiRequest(`${API_URL}/products/${productId}`, 'DELETE');
                fetchProducts(); // Recargar la lista
            } catch (error) {
                alert(`Error al eliminar el producto: ${error.message}`);
            }
        }

        function purchaseProduct(productId) {
            alert('Para comprar, por favor, inicie sesión.');
        }

        // --- Lógica de Autenticación (Cognito) ---
        async function handleAuthFormSubmit(event) {
            event.preventDefault();
            const mode = event.target.dataset.mode;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('auth-error');
            errorEl.classList.add('hidden');

            const cognito = new AWS.CognitoIdentityServiceProvider();

            if (mode === 'register') {
                const confirmPassword = document.getElementById('confirm-password').value;
                if (password !== confirmPassword) {
                    errorEl.textContent = 'Las contraseñas no coinciden.';
                    errorEl.classList.remove('hidden');
                    return;
                }
                cognito.signUp({
                    ClientId: COGNITO_CLIENT_ID,
                    Username: email,
                    Password: password,
                    UserAttributes: [{ Name: 'email', Value: email }]
                }, (err, data) => {
                    if (err) {
                        errorEl.textContent = err.message;
                        errorEl.classList.remove('hidden');
                    } else {
                        alert('¡Registro exitoso! Por favor, revisa tu correo para verificar tu cuenta. Luego podrás iniciar sesión.');
                        closeAuthModal();
                    }
                });
            } else { // login
                cognito.initiateAuth({
                    AuthFlow: 'USER_SRP_AUTH',
                    ClientId: COGNITO_CLIENT_ID,
                    AuthParameters: { USERNAME: email, PASSWORD: password }
                }, (err, data) => {
                    if (err) {
                        errorEl.textContent = err.message;
                        errorEl.classList.remove('hidden');
                    } else {
                        state.jwtToken = data.AuthenticationResult.IdToken;
                        state.isLoggedIn = true;
                        localStorage.setItem('jwtToken', state.jwtToken);
                        localStorage.setItem('userEmail', email);
                        document.getElementById('user-email').textContent = email;
                        closeAuthModal();
                        updateUI();
                    }
                });
            }
        }

        function logout() {
            state.isLoggedIn = false;
            state.jwtToken = null;
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('userEmail');
            updateUI();
        }

        // --- Helper para API ---
        async function apiRequest(url, method, body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (state.jwtToken) {
                headers['Authorization'] = state.jwtToken;
            }
            const options = { method, headers };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(url, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Error ${response.status}`);
            }
            return response.status === 204 ? null : response.json();
        }

    </script>

</body>
</html>
