<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda de Licencias - NetSolutions</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1093.0.min.js"></script>
</head>
<body>

    <div id="toast-container" class="toast-container"></div>

    <div class="container">
        <header>
            <h1>NetSolutions</h1>
            <nav id="auth-nav" aria-label="Autenticación de usuario">
                <div id="logged-out-view">
                    <button data-action="show-login">Iniciar Sesión</button>
                    <button data-action="show-register" class="primary">Registrarse</button>
                </div>
                <div id="logged-in-view" class="hidden">
                    <span id="user-email"></span>
                    <button data-action="logout">Cerrar Sesión</button>
                </div>
            </nav>
        </header>

        <main>
            <section id="admin-controls" class="admin-controls hidden" aria-label="Controles de administrador">
                <h2>Panel de Administrador</h2>
                <button data-action="show-add-product" class="primary">+ Añadir Nuevo Producto</button>
            </section>

            <section aria-labelledby="products-heading">
                <h2 id="products-heading">Venta de Licencias de Software</h2>
                <div id="product-grid" class="product-grid">
                    <p class="loader">Cargando productos...</p>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 NetSolutions S.A.S. - Arquitectura en AWS</p>
        </footer>
    </div>

    <!-- Modal de Autenticación -->
    <div id="auth-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="auth-modal-title">
        <div class="modal-content">
            <h2 id="auth-modal-title">Iniciar Sesión</h2>
            <form id="auth-form" novalidate>
                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <div id="confirm-password-group" class="form-group hidden">
                    <label for="confirm-password">Confirmar Contraseña</label>
                    <input type="password" id="confirm-password" autocomplete="new-password">
                </div>
                <p id="auth-error" class="error-message hidden" aria-live="assertive"></p>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" data-action="close-auth-modal">Cancelar</button>
                    <button type="submit" class="primary" id="auth-submit-button">Acceder</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Producto (Crear/Editar) -->
    <div id="product-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="product-modal-title">
        <div class="modal-content">
            <h2 id="product-modal-title">Añadir Nuevo Producto</h2>
            <form id="product-form" novalidate>
                <input type="hidden" id="product-id">
                <div class="form-group">
                    <label for="product-name">Nombre</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label for="product-description">Descripción</label>
                    <textarea id="product-description" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="product-category">Categoría</label>
                    <input type="text" id="product-category" required>
                </div>
                <div class="form-group">
                    <label for="product-price">Precio (USD)</label>
                    <input type="number" id="product-price" step="0.01" required>
                </div>
                <p id="product-error" class="error-message hidden" aria-live="assertive"></p>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" data-action="close-product-modal">Cancelar</button>
                    <button type="submit" class="primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // Usamos un IIFE (Immediately Invoked Function Expression) para encapsular nuestro código
    // y no contaminar el scope global.
    ((window, document) => {
        'use strict';

        // --- 1. CONFIGURACIÓN Y ESTADO --- //
        const config = {
            cognitoUserPoolId: '${cognito_user_pool_id}',
            cognitoClientId: '${cognito_app_client_id}',
            apiUrl: '${api_url}',
            awsRegion: 'us-east-1'
        };

        const state = {
            isLoggedIn: false,
            jwtToken: null,
            products: [],
            user: null
        };

        // --- 2. CACHÉ DE ELEMENTOS DEL DOM --- //
        const dom = {
            authNav: document.getElementById('auth-nav'),
            loggedOutView: document.getElementById('logged-out-view'),
            loggedInView: document.getElementById('logged-in-view'),
            userEmailSpan: document.getElementById('user-email'),
            adminControls: document.getElementById('admin-controls'),
            productGrid: document.getElementById('product-grid'),
            authModal: { 
                overlay: document.getElementById('auth-modal'),
                title: document.getElementById('auth-modal-title'),
                form: document.getElementById('auth-form'),
                confirmPassGroup: document.getElementById('confirm-password-group'),
                submitButton: document.getElementById('auth-submit-button'),
                error: document.getElementById('auth-error')
            },
            productModal: {
                overlay: document.getElementById('product-modal'),
                title: document.getElementById('product-modal-title'),
                form: document.getElementById('product-form'),
                error: document.getElementById('product-error'),
                idInput: document.getElementById('product-id')
            },
            toastContainer: document.getElementById('toast-container')
        };

        // --- 3. LÓGICA DE UI (INTERFAZ DE USUARIO) --- //
        const ui = {
            updateAuthView() {
                dom.loggedInView.classList.toggle('hidden', !state.isLoggedIn);
                dom.loggedOutView.classList.toggle('hidden', state.isLoggedIn);
                dom.adminControls.classList.toggle('hidden', !state.isLoggedIn);
                if (state.isLoggedIn && state.user) {
                    dom.userEmailSpan.textContent = state.user.email;
                }
            },
            renderProducts() {
                if (state.products.length === 0) {
                    dom.productGrid.innerHTML = '<p>No hay productos disponibles.</p>';
                    return;
                }
                dom.productGrid.innerHTML = state.products.map(product => {
                    const adminActions = '<div class="product-card-actions"><button class="btn-secondary" data-action="show-edit-product" data-id="' + product.id + '">Editar</button><button class="btn-danger" data-action="delete-product" data-id="' + product.id + '">Borrar</button></div>';
                    const userActions = '<button class="buy-button" data-action="purchase-product" data-id="' + product.id + '">Comprar Ahora</button>';
                    return (
                        '<div class="product-card">' +
                            '<div class="product-card-content">' +
                                '<h3>' + product.name + '</h3>' +
                                '<p>' + product.description + '</p>' +
                                '<p class="product-price">$' + product.price + ' USD</p>' +
                                (state.isLoggedIn ? adminActions : userActions) +
                            '</div>' +
                        '</div>'
                    );
                }).join('');
            },
            toggleModal(modal, show) {
                modal.overlay.classList.toggle('hidden', !show);
                if(show) modal.form.reset();
            },
            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                dom.toastContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10); // Animar entrada
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 5000);
            }
        };

        // --- 4. LÓGICA DE API (CLIENTE HTTP) --- //
        const api = {
            async request(endpoint, method, body = null) {
                const headers = { 'Content-Type': 'application/json' };
                if (state.jwtToken) {
                    headers['Authorization'] = state.jwtToken;
                }
                const options = { method, headers };
                if (body) options.body = JSON.stringify(body);

                const response = await fetch(config.apiUrl + endpoint, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error ${response.status}`);
                }
                return response.status === 204 ? null : response.json();
            },
            getProducts() { return this.request('/products', 'GET'); },
            createProduct(data) { return this.request('/products', 'POST', data); },
            updateProduct(id, data) { return this.request(`/products/${id}`, 'PUT', data); },
            deleteProduct(id) { return this.request(`/products/${id}`, 'DELETE'); }
        };

        // --- 5. LÓGICA DE AUTENTICACIÓN (COGNITO) --- //
        const auth = {
            cognitoProvider: null,
            init() {
                AWS.config.update({ region: config.awsRegion });
                this.cognitoProvider = new AWS.CognitoIdentityServiceProvider();
            },
            signUp(email, password) {
                return new Promise((resolve, reject) => {
                    this.cognitoProvider.signUp({
                        ClientId: config.cognitoClientId,
                        Username: email,
                        Password: password,
                        UserAttributes: [{ Name: 'email', Value: email }]
                    }, (err, data) => err ? reject(err) : resolve(data));
                });
            },
            signIn(email, password) {
                return new Promise((resolve, reject) => {
                    this.cognitoProvider.initiateAuth({
                        AuthFlow: 'USER_SRP_AUTH',
                        ClientId: config.cognitoClientId,
                        AuthParameters: { USERNAME: email, PASSWORD: password }
                    }, (err, data) => err ? reject(err) : resolve(data));
                });
            },
            logout() {
                state.isLoggedIn = false;
                state.jwtToken = null;
                state.user = null;
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('userEmail');
            },
            handleLoginSuccess(authResult, email) {
                state.jwtToken = authResult.IdToken;
                state.isLoggedIn = true;
                state.user = { email };
                localStorage.setItem('jwtToken', state.jwtToken);
                localStorage.setItem('userEmail', email);
            }
        };

        // --- 6. MANEJADORES DE EVENTOS --- //
        const events = {
            init() {
                dom.authNav.addEventListener('click', this.handleAuthNavClick);
                dom.authModal.form.addEventListener('submit', this.handleAuthFormSubmit);
                dom.productModal.form.addEventListener('submit', this.handleProductFormSubmit);
                dom.productGrid.addEventListener('click', this.handleProductGridClick);
                dom.authModal.overlay.addEventListener('click', e => e.target === dom.authModal.overlay && ui.toggleModal(dom.authModal, false));
                dom.productModal.overlay.addEventListener('click', e => e.target === dom.productModal.overlay && ui.toggleModal(dom.productModal, false));
            },
            async handleAuthNavClick(e) {
                const action = e.target.dataset.action;
                if (action === 'show-login') {
                    ui.toggleModal(dom.authModal, true);
                    dom.authModal.title.textContent = 'Iniciar Sesión';
                    dom.authModal.submitButton.textContent = 'Acceder';
                    dom.authModal.confirmPassGroup.classList.add('hidden');
                    dom.authModal.form.dataset.mode = 'login';
                } else if (action === 'show-register') {
                    ui.toggleModal(dom.authModal, true);
                    dom.authModal.title.textContent = 'Registrarse';
                    dom.authModal.submitButton.textContent = 'Crear Cuenta';
                    dom.authModal.confirmPassGroup.classList.remove('hidden');
                    dom.authModal.form.dataset.mode = 'register';
                } else if (action === 'logout') {
                    auth.logout();
                    ui.updateAuthView();
                    ui.renderProducts();
                    ui.showToast('Has cerrado sesión.');
                } else if (action === 'close-auth-modal') {
                    ui.toggleModal(dom.authModal, false);
                }
            },
            async handleAuthFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const mode = form.dataset.mode;
                const email = form.email.value;
                const password = form.password.value;
                dom.authModal.error.classList.add('hidden');

                try {
                    if (mode === 'register') {
                        const confirmPassword = form['confirm-password'].value;
                        if (password !== confirmPassword) throw new Error('Las contraseñas no coinciden.');
                        await auth.signUp(email, password);
                        ui.showToast('¡Registro exitoso! Revisa tu correo para verificar la cuenta.');
                        ui.toggleModal(dom.authModal, false);
                    } else {
                        const result = await auth.signIn(email, password);
                        auth.handleLoginSuccess(result.AuthenticationResult, email);
                        ui.updateAuthView();
                        ui.renderProducts();
                        ui.showToast('¡Inicio de sesión exitoso!');
                        ui.toggleModal(dom.authModal, false);
                    }
                } catch (err) {
                    dom.authModal.error.textContent = err.message;
                    dom.authModal.error.classList.remove('hidden');
                }
            },
            async handleProductFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const mode = form.dataset.mode;
                const productData = {
                    name: dom.productModal.form.name.value,
                    description: dom.productModal.form.description.value,
                    category: dom.productModal.form.category.value,
                    price: parseFloat(dom.productModal.form.price.value),
                };
                try {
                    if (mode === 'edit') {
                        await api.updateProduct(dom.productModal.idInput.value, productData);
                        ui.showToast('Producto actualizado con éxito.');
                    } else {
                        await api.createProduct(productData);
                        ui.showToast('Producto creado con éxito.');
                    }
                    ui.toggleModal(dom.productModal, false);
                    await main.loadProducts();
                } catch (err) {
                    dom.productModal.error.textContent = err.message;
                    dom.productModal.error.classList.remove('hidden');
                }
            },
            handleProductGridClick(e) {
                const action = e.target.dataset.action;
                const id = e.target.dataset.id;
                if (!action) return;

                if (action === 'show-edit-product') {
                    const product = state.products.find(p => p.id === id);
                    if (product) {
                        const modal = dom.productModal;
                        ui.toggleModal(modal, true);
                        modal.title.textContent = 'Editar Producto';
                        modal.form.dataset.mode = 'edit';
                        modal.idInput.value = product.id;
                        modal.form.name.value = product.name;
                        modal.form.description.value = product.description;
                        modal.form.category.value = product.category;
                        modal.form.price.value = product.price;
                    }
                } else if (action === 'delete-product') {
                    if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                        api.deleteProduct(id)
                            .then(() => {
                                ui.showToast('Producto eliminado con éxito.');
                                main.loadProducts();
                            })
                            .catch(err => {
                                ui.showToast(`Error al eliminar: ${err.message}`, 'error');
                            });
                    }
                } else if (action === 'purchase-product') {
                    ui.showToast('Para comprar, por favor, inicie sesión.', 'error');
                }
            }
        };

        // --- 7. FUNCIÓN PRINCIPAL DE INICIALIZACIÓN --- //
        const main = {
            async init() {
                auth.init();
                this.loadInitialState();
                ui.updateAuthView();
                await this.loadProducts();
                events.init();
            },
            loadInitialState() {
                const token = localStorage.getItem('jwtToken');
                if (token) {
                    state.jwtToken = token;
                    state.isLoggedIn = true;
                    state.user = { email: localStorage.getItem('userEmail') };
                }
            },
            async loadProducts() {
                try {
                    dom.productGrid.innerHTML = '<p class="loader">Cargando productos...</p>';
                    state.products = await api.getProducts();
                    ui.renderProducts();
                } catch (err) {
                    dom.productGrid.innerHTML = '<p>Error al cargar los productos.</p>';
                    console.error(err);
                }
            }
        };

        // --- ARRANQUE DE LA APLICACIÓN ---
        document.addEventListener('DOMContentLoaded', () => main.init());

    })(window, document);
    </script>

</body>
</html>